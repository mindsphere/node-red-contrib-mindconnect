<!-- // Copyright Siemens AG, 2017-->
<link href="mindsphere.css" rel="stylesheet"/>

<script type="text/x-red" data-template-name="mindconnect">
    <div id="_msbar">
        <span  style="line-height:36px">
            &nbsp;&nbsp;<a href="https://opensource.mindsphere.io/docs/node-red-contrib-mindconnect/index.html" target="_new" class="headerLink" title="Documentation">
                <i class="fa fa-globe"></i> MindConnect Node-RED Agent 
            </a>
        </span> <span style="color:#aaaaaa !important">v3.7.0</span>
    </div>

    <div class="form-row">
        <label for="node-input-name" title="Agent Name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="" title="Security Profile (SHARED_SECRET | RSA_3072)"><i class="fa fa-lock"></i> Profile</span></label>
        <select id="input-config-type-select">
            <option value="SHARED_SECRET">SHARED_SECRET</option>
            <option value="RSA_3072">RSA_3072</option>
        </select>
    </div>

    <div class="form-row node-text-editor-row">
            <label for=" title="Retry n times before throwing an error."><i class="fa fa-repeat"></i> Retries</span></label>
            <input id="node-input-retry" class="ui-spinner-input" value="1" style="width:50px"/>
    </div>

    <div class="form-row node-text-editor-row">
        <label for="" title="Maximum number of asynchronous requests."><i class="fa fa-arrow-circle-up"></i> 
            Max. Async Requests</span></label>
        <input id="node-input-parallel" class="ui-spinner-input" value="1" style="width:50px"/>
    </div>

    <div class="form-row node-text-editor-row">
        <label for="" title="wait for all started requests to finish after x seconds"><i class="fa fa-arrow-circle-down"></i> 
            Async Duration </span></label>
        <input id="node-input-asyncduration" class="ui-spinner-input" value="1" style="width:50px"/> (in seconds)
    </div>

    <div class="form-row node-text-editor-row">
        <p>
            <span id="noLinkSpan">
                <i class="fa fa-id-card"></i> Agent Configuration
            </span>
            <span id="linkSpan" style="margin-top: 5px">
                <a id="configLink" target="_new" title="Agent Configuration in the MindSphere"><i class="fa fa-external-link"></i> Agent Configuration</a> 
                &nbsp;<a id="diagLink" class="diagLink" target="_new" title="Agent Diagnotic in MindSphere"><i class="fa fa-stethoscope" aria-hidden="true"></i><a>
                <a id="resetLink" class="deleteLink" style="float:right" title="Delete local agent configuration."><i class="fa fa-trash"></i></a>
            </span>
        </p>
        <p id="deleteConfig" style="color: #af235f !important; display:none">
            Please re-deploy the flow to delete the local configuration!
        </p>
        <textarea style="height: 150px; min-height:150px; width:100%; overflow-y:scroll" class="node-text-editor" id="node-input-agentconfig"
            placeholder="Copy Authentication JSON from MindSphere (use MindConnectLib [core.mclib] asset type)"></textarea>
    </div>

     
    <div id="dialog" title="Delete local agent configuration?" style="display:none">

        <p>
            <i class="fa fa-exclamation-triangle"style="float:left; color: #af235f !important; font-size: 300% !important; margin-right:20px" aria-hidden="true"></i>
            The local agent configuration (including the data stored in <span style="color: #af235f !important" id="idLink"></span>) 
            will be deleted. Are you sure?
        </p>
    </div>
    
    <div class="form-row node-text-editor-row hidden" id="private-key">
        <p><i class="fa fa-key"></i> RSA 3072 Private Key</p>
        <textarea style="height: 150px; min-height:150px; width:100%; overflow-y:scroll" class="node-text-editor" id="node-input-privatekey"
            placeholder="Generate a key with: openssl genrsa -out private.key 3072"></textarea>
    </div>
    
    <div class="form-row node-text-editor-row">
        <label for="node-input-validate"><i class="fa fa-cog"></i> Settings</label>
        <label for="node-input-validate" style="width:70%">
        <input type="checkbox" id="node-input-validate" style="display:inline-block; width:22px; vertical-align:baseline;">Validate datapoints before sending.</label>
    </div>

    <div class="form-row node-text-editor-row">
        <label for="node-input-validateevent"></label>
        <label for="node-input-validateevent" style="width:70%">
        <input type="checkbox" id="node-input-validateevent" style="display:inline-block; width:22px; vertical-align:baseline;">Validate event before sending.</label>
    </div>
    
    <div class="form-row node-text-editor-row">
        <label for="node-input-chunk"></label>
        <label for="node-input-chunk" style="width:70%">
        <input type="checkbox" id="node-input-chunk" style="display:inline-block; width:22px; vertical-align:baseline;">Upload file in chunks. </label> 
    </div>

    <div class="form-row node-text-editor-row">
        <label for="node-input-disablekeepalive"></label>
        <label for="node-input-disablekeepalive" style="width:70%"  data-toggle="tooltip" data-placement="top" title="The node will rotate the keys regularly even when there is no data sent unless disabled.">
        <input type="checkbox" id="node-input-disablekeepalive" style="display:inline-block; width:22px; vertical-align:baseline;">Disable keep alive. </label>
    </div>


    <div class="form-tips"><i class="fa fa-info-circle"></i> <b>Tip:</b> 
        Use MindSphere UI to configure the agent configuration and the mappings for the node. 
        <br/></br/>
        <i class="fa fa-info-circle"></i> <b>Validation settings:</b>
        Switching the validation of the events or datapoints off gives you a very minor speed-up on the client but it disables all semantic validation and error messages. 
        The recommended setting is to leave the validation on.
        <br/><br/>
        <i class="fa fa-info-circle"></i> <b>Keep alive:</b>
        The node will check/renew the communication token every hour even when there is no data sent.
        The recommended setting is to leave the keep alive enabled.
        <br/><br/>
        <i class="fa fa-info-circle"></i> <b>Max async requests:</b>
        If this setting is &gt; 1 the node will not wait for every request to finish running
        before continuing with the next request. The setting also determines the maximal number of
        parallel multipart uploads. 
        <br/><br/>
        <i class="fa fa-info-circle"></i> <b>Async duration:</b>
        The node will wait for started requests to finish after configured number of seconds independent of 
        the maximum number of configured parallel requests.
    </div>

</script>

<script type="text/x-red" data-help-name="mindconnect">
    <p><b>Node connecting the flow to MindSphere.</b><br/>
    This node can send data points (single or in bulk), events or upload a file to MindSphere.
    </p>
  
    <p><i class="fa fa-info-circle"></i> <b>Data Points:</b><br/>
        In order to send datapoints to MindSphere you have to pass the following message in the msg.payload (e.g. from a function node)
        </p>
    <pre>
const values = [
    { 
        "dataPointId": "100000000", 
        "qualityCode": "1", 
        "value": "42"
    },
    { 
        "dataPointId": "100000001", 
        "qualityCode": "1", 
        "value": "False"
    }
];

msg._time = new Date();
msg.payload = values;  
return msg;

    </pre>

    <p><i class="fa fa-info-circle"></i> <b>Data Points (bulk):</b><br/>
        In order to send datapoints in a bulk to MindSphere you have to pass the following message in the msg.payload (e.g. from a function node)
        </p>
    <pre>
const values = [
    {
        "timestamp":"2018-11-09T02:17:17.171Z",
        "values":[
            {"dataPointId":"100000000","qualityCode":"1","value":"42"}
            {"dataPointId":"100000001","qualityCode":"1","value":"42"}
        ]
    },
    {
        "timestamp":"2018-11-08T02:17:17.171Z",
        "values":[
            {"dataPointId":"100000000","qualityCode":"1","value":"42"}
            {"dataPointId":"100000001","qualityCode":"1","value":"42"}
        ]
    }
]

msg.payload = values;  
return msg;
    </pre>
    <p><i class="fa fa-info-circle"></i> <b>Events:</b><br/>
        Send an event to MindSphere by passing the event message in the payload. You can send events to all assets you have access to in your tenant. Pass the
        assetid in the entity id property.
        </p>
    <pre>
msg.payload = {
    "entityId": "1234567890abcdef1234567890abcdef", // use assetid if you want to send event somewhere else :)
    "sourceType": "Agent",
    "sourceId": "application",
    "source": "MindConnect Agent",
    "severity": 20, // 0-99 : 20:error, 30:warning, 40: information
    "description": "Event sent at " + new Date().toISOString(),
    "timestamp": new Date().toISOString(), // you have to set the timestamp here 
    "additionalProperty" : ""
};

return msg;
    </pre>


    <p><i class="fa fa-info-circle"></i> <b>File Upload:</b><br/>
        You have to pass the object with file information in the message: 
        </p>
    <pre>
msg.payload = {
    entityId: "1234567890abcdef1234567890abcdef", //optional
    fileName : "digitaltwin.png", // you can also pass a Buffer object instead
    fileType : "image/png", //optional
    filePath : "images/digitaltwin.png",
    description: "image uploaded with node-red-contrib-mindconnect"
} 

return msg;
    </pre>




    <p>You can force the onboarding or the retrival of the agent configuration by setting
        the following parameters on the message. (This should be used for debugging only!)
    </p>
    <pre>
msg._forceOnBoard= true;
msg._forceGetConfig = true;          
    </pre>

    <p>
        <i class="fa fa-info-circle"></i> <b>Error Handling:</b><br/>
    </p>
    <p>
    The following two properties can be used to create more complex error flows:
    </p>
    <pre>
msg._mindsphereStatus; // OK on success othervise error
msg_error; // The timestamped error message
    </pre>
    
    <p>
        More Documentation:
        <ul>
            <li> <a href="https://opensource.mindsphere.io" target="_new"><i class="fa fa-external-link"></i> MindSphere Open Source Tools and Libraries</a></li>
            <li> <a href="https://developer.mindsphere.io" target="_new"><i class="fa fa-external-link"></i> MindSphere Developer Documentation</a></li>

            <li><a href="https://community.plm.automation.siemens.com/t5/Developer-Space/bd-p/MindSphere-platform-forum" target="_new" title="Community"><i class="fa fa-external-link"></i> MindSphere Developer Forum</a> </li>

        </ul>
    </p>

</script>
<script type="text/javascript" src="ajv.min.js" />

<script type="text/javascript">

    const configurationSchema = {
        "type": "object",
        "required": ["content"],
        "properties": {
            "content": {
            "type": "object",
            "required": ["baseUrl", "iat", "clientCredentialProfile", "clientId", "tenant"],
            "properties": {
                "baseUrl": {
                "type": "string"
                },
                "iat": {
                "type": "string"
                },
                "clientCredentialProfile": {
                "type": "array",
                "items": {
                    "type": "string"
                }
                },
                "clientId": {
                "type": "string"
                },
                "tenant": {
                "type": "string"
                }
            }
            },
            "expiration": {
            "type": "string"
            }
        }
    };

    function configValidator() {
        const schemaValidator = new Ajv({ $data: true, allErrors: true });
        return schemaValidator.compile(configurationSchema);
    }

    RED.nodes.registerType('mindconnect', {
        category: 'mindsphere',
        color: '#41aaaa',
        defaults: {
            name: {
                value: ""
            },
            configtype: {
                value: ""
            },
            agentconfig: {
                value: "",
                required: true,
                validate: (v) => { 
                    try {
                    const data = JSON.parse(v);
                    if (data.action === "delete" && data.clientId) {
                        return true;
                    }
                    const validator=configValidator(); 
                    const result= validator(data); 
                    return result;

                    } catch (err) {
                        console.log(err);
                    }
                    return false;
                }
            },
            privatekey: {
                value: "",
                validate: (v) => { 
                    try {
                        const mode = $("#input-config-type-select").val(); 
                        if (!mode || mode === "SHARED_SECRET") {
                            return true;
                        }
                        
                        v = v.trim();
                        if (!v.endsWith("\n")) 
                            v+= "\n";

                        if (!v.startsWith("-----BEGIN RSA PRIVATE KEY-----")) {
                            return false;
                        }

                        if (!v.endsWith("-----END RSA PRIVATE KEY-----\n")) {
                            return false;
                        }
                        return true;
                    } catch (err) {
                        console.log(err);
                    }
                    return false;
                }
            },
            model: {
                value: ""
            },
            validate: {
                value: true
            },
            validateevent: {
                value: true
            },
            chunk: {
                value: false
            },
            disablekeepalive: {
                value: false
            },
            retry : {
                value:3,
                validate: RED.validators.number()
            },
            parallel : {
                value:1,
                validate: RED.validators.number()
            },
            asyncduration : {
                value:1,
                validate: RED.validators.number()
            }

        },
        inputs: 1,
        outputs: 1,
        icon: "white-globe.png",
        label: function () {
            return this.name || "MindConnect Node-RED Agent";
        },
     
        oneditprepare: function () {

            $("#noLinkSpan").hide();
            try {
                const node = this;
                const agentConfig = JSON.parse(this.agentconfig);
                const target = agentConfig.content.baseUrl.replace("southgate", `${agentConfig.content.tenant}-assetmanager`) + `/entity/${agentConfig.content.clientId}/plugin/uipluginassetmanagermclib`;
                const diag = agentConfig.content.baseUrl.replace("southgate", `${agentConfig.content.tenant}-agentdiagnostic`);

                $("#configLink").attr("href", target);
                $("#diagLink").attr("href", diag);
                $("#idLink").text(`.mc/${agentConfig.content.clientId}.json`);

                $("#resetLink").click(()=>{
                    $("#dialog").dialog({
                        modal:true,
                        width:500,
                        resizable: false,
                        buttons: {
                             "Delete configuration": function() {
                                    $("#linkSpan").hide();
                                    $("#noLinkSpan").hide();
                                    $("#deleteConfig").show();
                                    // node.agentConfig = {action: "delete", clientId:`${agentConfig.content.clientId}`};
                                    $("#node-input-agentconfig").val(JSON.stringify({action: "delete", clientId: `${agentConfig.content.clientId}`}));
                                    $( this ).dialog( "close" );
                            },
                            Cancel: function() {
                                $( this ).dialog( "close" );
                            }
                        }
                    });
                    return false;
                });

            } catch (err) {
                $("#linkSpan").hide();
                $("#noLinkSpan").show();
            }

            const c=this.retry;
            $("#node-input-retry").val(c);
            $("#node-input-retry").spinner({
                max:10,
                min:1
            });

            const p=this.parallel || 1;

            $("#node-input-parallel").val(p);
            $("#node-input-parallel").spinner({
                max:10,
                min:1
            });


            const a=this.asyncduration || 10;

            $("#node-input-asyncduration").val(a);
            $("#node-input-asyncduration").spinner({
                max:600,
                min:1
            });



            $("#input-config-type-select").change(function () {
                let value = $("#input-config-type-select").val();
                if (value === "SHARED_SECRET") {
                    $("#private-key").hide();
                } else {
                    $("#private-key").show();
                }
            });

            console.log(this.configtype);

            if (this.configtype === "RSA_3072") {
                $("#input-config-type-select").val("RSA_3072");
                $("#private-key").show();
            } else {
                $("#input-config-type-select").val("SHARED_SECRET");
                $("#private-key").hide();
            }
        },
        oneditsave: function () {
            this.configtype = $("#input-config-type-select").val();
        }
    });
</script>